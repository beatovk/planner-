#!/usr/bin/env python3
"""
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç –∫—É–ª—å—Ç—É—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏–∑ CSV —Ñ–∞–π–ª–∞
"""

import csv
import os
import sys
from datetime import datetime
from sqlalchemy.exc import IntegrityError

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from apps.core.db import SessionLocal
from apps.places.models import Place

def add_culture_arts_places(file_path: str):
    """–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞ –∫—É–ª—å—Ç—É—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏–∑ CSV"""
    db = SessionLocal()
    added_count = 0
    skipped_count = 0
    total_rows = 0

    try:
        with open(file_path, mode='r', encoding='utf-8') as csvfile:
            reader = csv.DictReader(csvfile)
            places_to_add = []
            
            for row in reader:
                total_rows += 1
                name = row.get('name')
                subcategory = row.get('subcategory')
                description_full = row.get('description_full')
                source_url = row.get('source_url')

                if not name or not description_full:
                    print(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –º–µ—Å—Ç–æ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–º–µ–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è: {row}")
                    skipped_count += 1
                    continue

                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π source_url –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
                if not source_url:
                    source_url = f"culture_arts_batch_02_{name.lower().replace(' ', '_').replace('(', '').replace(')', '').replace('‚Äî', '_').replace('.', '').replace(',', '')}"

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                existing_place = db.query(Place).filter(
                    (Place.name == name) | (Place.source_url == source_url)
                ).first()

                if existing_place:
                    skipped_count += 1
                    continue

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ subcategory
                category = "gallery"
                if subcategory == "Museum":
                    category = "museum"
                elif subcategory == "Theatre & Show":
                    category = "theater"
                elif subcategory == "Cinema":
                    category = "cinema"

                new_place = Place(
                    name=name,
                    description_full=description_full,
                    category=category,
                    processing_status="new",
                    source="culture_arts_batch_02",
                    source_url=source_url,
                    scraped_at=datetime.now()
                )
                places_to_add.append(new_place)

            if places_to_add:
                db.bulk_save_objects(places_to_add)
                db.commit()
                added_count = len(places_to_add)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {added_count} –Ω–æ–≤—ã—Ö –º–µ—Å—Ç –∫—É–ª—å—Ç—É—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞")

    except IntegrityError as e:
        db.rollback()
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
    except Exception as e:
        db.rollback()
        print(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        db.close()

    print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç:")
    print(f"  –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –º–µ—Å—Ç: {added_count}")
    print(f"  –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): {skipped_count}")
    print(f"  –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {total_rows}")

if __name__ == "__main__":
    csv_file_path = '../docs/places.csv/+ Bangkok_Culture___Arts___Batch_02__verified_.csv'
    print(f"üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç –∫—É–ª—å—Ç—É—Ä—ã –∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏–∑ {csv_file_path.split('/')[-1]}\n" + "="*60)
    add_culture_arts_places(csv_file_path)
